@page
@model iTech.Areas.Admin.Pages.Configurations.ManageEditorPlan.IndexModel

@{
    ViewBag.Title = "Editor Request Plans";
    ViewBag.pTitle = "Editor Request Plans";
    ViewBag.pageTitle = "Editor Request Plans";
}
<partial name="_DatchDelete" model="@Model.WebEditorPlan" view-data="ViewData" />

<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar  py-3 py-lg-6 ">
        <!--begin::Toolbar container-->
        <div id="kt_app_toolbar_container" class="app-container  container-fluid d-flex flex-stack ">
            <!--begin::Page title-->
            <div data-kt-swapper="true" data-kt-swapper-mode="{default: 'prepend', lg: 'prepend'}" data-kt-swapper-parent="{default: '#kt_app_content_container', lg: '#kt_app_toolbar_container'}" class="page-title d-flex flex-column justify-content-center flex-wrap me-3 mb-5 mb-lg-0">
                <!--begin::Title-->
                <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                    @sharedResource["Editor Request Plans"]
                </h1>
                <!--end::Title-->
            </div>
            <!--end::Page title-->
            <!--begin::Action group-->
            <div class="d-flex align-items-center gap-2">
                <div class="d-flex align-items-center gap-2 gap-lg-3">
                    <button type="button" class="btn btn-sm btn-light-primary" data-bs-toggle="modal" id="create-btn" data-bs-target="#AddModal">
                        <i class="ki-duotone ki-plus fs-2"></i> @sharedResource["Add Editor Plan"]
                    </button>
                    <!--end::Primary button-->
                </div>
            </div>
            <!--end::Action group-->
        </div>
        <!--end::Toolbar container-->
    </div>
    <div id="kt_app_content" class="app-content  flex-column-fluid ">


        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container  container-fluid ">

            <div class="card">

                <div class="card-body">
                    <table id="tblList" class="table table-striped table-row-bordered gy-5 gs-7 border rounded">
                        <thead>
                            <tr class="fw-bold fs-6 text-gray-800 px-7">
                                <th hidden>id</th>
                                <th class="min-w-125px">@sharedResource["TitleAr"]</th>
                                <th class="min-w-125px">@sharedResource["TitleEn"]</th>

                                <th class="min-w-125px">@sharedResource["Price"]</th>
                                <th class="min-w-125px">@sharedResource["Price After Discount"]</th>
                                 <th class="min-w-125px text-end">@sharedResource["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>


                </div>

            </div>

        </div>

    </div>
</div>

<partial name="_EditPopup" model="@Model.WebEditorPlan" view-data="ViewData" />
<partial name="_AddPopup" model="@Model.WebEditorPlan" view-data="ViewData" />
<partial name="_ViewPopup" model="@Model.WebEditorPlan" view-data="ViewData" />


<script src="~/Other/lib/jquery/dist/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#tblList").DataTable({
            "proccessing": true,
            "serverSide": true,
            "ajax": {

                url: "/admin/Configurations/ManageEditorPlan/Index",
                type: 'POST',
                headers: { 'XSRF-TOKEN': $('@Html.AntiForgeryToken()').val() }
            },
            "columnDefs": [
                {
                    "targets": -1,
                    "data": null,
                    "render": function (data, type, row, meta) {
                        return `<a href="javascript:void(0)" data-bs-toggle="modal" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                                                                <i class="ki-duotone ki-eye fs-2x" onclick="ShowViewPopUp(${row.WebEditorPlanId})">
                                                                                    <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                            <span class="path3"></span>
                                                                            </i>

                                                                </a>
                                                                <a class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" href="javascript:void(0)" data-bs-toggle="modal">
                                                                                        <i class="ki-duotone ki-pencil fs-2" onclick="editButtonClick(${row.WebEditorPlanId})">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                </a>

                                                                <a href="#" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm" data-bs-toggle="modal" href="javascript:void(0)">
                                                                                            <i class="ki-duotone ki-trash fs-2" onclick="deleteWebEditorPlan(${row.WebEditorPlanId})">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                        <span class="path4"></span>
                                                                        <span class="path5"></span>
                                                                    </i>
                                                                </a>`;
                    },
                    "sortable": false
                },
                { "name": "WebEditorPlanId", "data": "WebEditorPlanId", "targets": 0, "visible": false },
                
                { "name": "TitleAr", "data": "TitleAr", "targets": 1, "visible": true },
                { "name": "TitleEn", "data": "TitleEn", "targets": 2, "visible": true },
                { "name": "Price", "data": "Price", "targets": 3, "visible": true },
                { "name": "PriceAfterDiscount", "data": "PriceAfterDiscount", "targets": 4, "visible": true }
                
                



            ],
            "order": [[1, "desc"]],
            "language": {
                "lengthMenu": "Show _MENU_",
            },
            "dom":
                "<'row'" +
                "<'col-sm-6 d-flex align-items-center justify-conten-start'l>" +
                "<'col-sm-6 d-flex align-items-center justify-content-end'f>" +
                ">" +

                "<'table-responsive'tr>" +

                "<'row'" +
                "<'col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start'i>" +
                "<'col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end'p>" +
                ">",
            "createdRow": function (row, data, dataIndex) {
                var tdElements = $(row).find('td');
                $(tdElements[tdElements.length - 1]).addClass('text-end');
            }
        });


        $('#add-bbtn').click(function (event) {
            // Prevent the default form submission
            event.preventDefault();
            submitFormSpecs();
        });
        $('#add-btn').click(function (event) {
            // Prevent the default form submission
            event.preventDefault();
            submitFormUpdateSpecs();
        });

    });
    var sectionCounter = 1;

    function addNewSectionSpecs() {
        var originalSection = $(".specifications-section:first");
        var pclonedSection = null;

        // If the original section is not visible, make it visible
        if (!originalSection.is(":visible")) {
            originalSection.show();
        } else {
            // If the original section is visible, clone it
            var clonedSection = originalSection.clone(true, true);
            clonedSection.find(".form-control").val('');
            $("#specsContainer").append(clonedSection);

        }
        
        


    }
    function addNewSectionUpdateSpecs() {
        var poriginalSection = $(".SpecSect:first");
        var pclonedSection = null;

        // If the original section is not visible, make it visible
        if (!poriginalSection.is(":visible")) {
            poriginalSection.show();
        } else {
            // If the original section is visible, clone it
            pclonedSection = poriginalSection.clone(true, true);
            pclonedSection.find(".form-control").val('');
            $("#specsUpdateContainer").append(pclonedSection);
        }
    }

    // Function to submit form with specifications data
    function submitFormSpecs() {
        var PlanSpecs = [];
        var titleAr = $('.add-plan-Specs-title-ar').val();
        var titleEn = $('.add-plan-Specs-title-en').val();
        var price = $('.add-plan-Specs-price').val();
        var priceAfterDisc = $('.add-plan-Specs-priceAfterDisc').val();


        // Loop through each specifications section
        $(".specifications-section").each(function () {
            var pltitleAr = $(this).find('.addSpecs-title-ar').val();
            var pltitleEn = $(this).find('.addSpecs-title-en').val();
            // Create an object for specifications data
           
            var plspec = {
                TitleAr: pltitleAr,
                TitleEn: pltitleEn,
            }
            PlanSpecs.push(plspec); // Push specs data to array
        });

        var ManageEditorPlan = {
            TitleAr: titleAr,
            TitleEn: titleEn,
            Price: price,
            PriceAfterDiscount: priceAfterDisc,
            PlanSpecs: PlanSpecs
        };
      

        $.ajax({
            type: "POST",
            url: "/Admin/Configurations/ManageEditorPlan/Index?handler=ManageWebEditorPlan",
            data: { ManageEditorPlan: ManageEditorPlan },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },

            headers: {
                RequestVerificationToken:
                    $('input:hidden[name="__RequestVerificationToken"]').val()
            },

            success: function (response) {
                window.location.href = "/Admin/Configurations/ManageEditorPlan/Index";

            },
            failure: function (response) {
                alert(response);
            }
        });
    }
    function submitFormUpdateSpecs() {
        var PlanSpecs = [];
        var planid = $('#HiddenplanId').val();
        var titleAr = $('.plan-Specs-title-ar').val();
        var titleEn = $('.plan-Specs-title-en').val();
        var price = $('.plan-Specs-price').val();
        var priceAfterDisc = $('.plan-Specs-priceAfterDisc').val();
        // Loop through each specifications section
        $(".SpecSect").each(function () {
            var pltitleAr = $(this).find('.specForEditAR').val();
            var pltitleEn = $(this).find('.specForEditEN').val();
            // Create an object for specifications data
            if (pltitleAr && pltitleEn) {
                // Create an object for specifications data
                var plspec = {
                    PlanSpecsId: parseInt(planid),
                    TitleAr: pltitleAr,
                    TitleEn: pltitleEn,
                }
                PlanSpecs.push(plspec); // Push specs data to array
            }
        });

        $("#PlanSpecsEditContainer .row").each(function () {
            var pltitleAr = $(this).find('.specForEditAR').val();
            var pltitleEn = $(this).find('.specForEditEN').val();
            // Create an object for specifications data
            if (pltitleAr && pltitleEn) {
                // Create an object for specifications data
                var plspec = {
                    PlanSpecsId: parseInt(planid),
                    TitleAr: pltitleAr,
                    TitleEn: pltitleEn,
                }
                PlanSpecs.push(plspec); // Push specs data to array
            }
        });

        var ManageEditorPlan = {
            WebEditorPlanId:parseInt(planid),
            TitleAr: titleAr,
            TitleEn: titleEn,
            Price: price,
            PriceAfterDiscount: priceAfterDisc,
            PlanSpecs: PlanSpecs
        };
        console.log(ManageEditorPlan);
        $.ajax({
            type: "POST",
            url: "/Admin/Configurations/ManageEditorPlan/Index?handler=ManageWebEditorPlan",
            data: { ManageEditorPlan: ManageEditorPlan },
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },

            headers: {
                RequestVerificationToken:
                    $('input:hidden[name="__RequestVerificationToken"]').val()
            },

            success: function (response) {
                 window.location.href = "/Admin/Configurations/ManageEditorPlan/Index";

            },
            failure: function (response) {
                alert(response);
            }
        });

    }
    function editButtonClick(WebEditorPlanId) {
        $.ajax({
            type: "GET",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            }
            ,
            url: "/Admin/Configurations/ManageEditorPlan/Index?handler=FindWebEditorPlan",

            data: { "WebEditorPlanId": WebEditorPlanId },
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
                document.getElementById("HiddenplanId").value = response.WebEditorPlanId
                document.getElementById("TitleArID").value = response.TitleAr
                document.getElementById("TitleEnID").value = response.TitleEn
                document.getElementById("priceplanid").value = response.Price
                document.getElementById("PriceAfterDiscountid").value = response.PriceAfterDiscount

            $("#PlanSpecsEditContainer").empty();

            if (response.PlanSpecs && response.PlanSpecs.length > 0) {
                response.PlanSpecs.forEach(function (spec) {
                        var specHtml = `
                               <div class="row">
                                                    <h5 b-cpu6lo70wp="">@(sharedResource["Plan Specification"])</h5>

                                                    <!--begin::Input group-->
                                                    <div b-cpu6lo70wp="" class="fv-row mb-10 fv-plugins-icon-container">
                                                        <!--begin::Label-->
                                                        <label b-cpu6lo70wp="" for="EditorPlanTitleAr" class="d-flex align-items-center fs-5 fw-semibold mb-2">
                                                            <span b-cpu6lo70wp="" class="required">@sharedResource["TitleAr"]</span>
                                                            <span b-cpu6lo70wp="" class="ms-1" data-bs-toggle="tooltip" aria-label="@sharedResource["TitleAr"]" data-bs-original-title="@sharedResource["Enter Arabic Title"]" data-kt-initialized="1">
                                                                <i b-cpu6lo70wp="" class="ki-duotone ki-information-5 text-gray-500 fs-6">
                                                                    <span b-cpu6lo70wp="" class="path1"></span>
                                                                    <span b-cpu6lo70wp="" class="path2"></span>
                                                                    <span b-cpu6lo70wp="" class="path3"></span>
                                                                </i>
                                                            </span>
                                                        </label>
                                                        <!--end::Label-->
                                                        <!--begin::Input-->
                                                                <input b-cpu6lo70wp=""  data-val-required="EditorPlanTitleAr" type="text" value="${spec.TitleAr}" class="form-control form-control-lg form-control-solid specForEditAR" placeholder="@sharedResource["Enter TitleAr"]">
                                                        <!--end::Input-->

                                                    </div>
                                                    <!--end::Input group-->
                                                    <!--begin::Input group-->
                                                    <div b-cpu6lo70wp="" class="fv-row mb-10 fv-plugins-icon-container">
                                                        <!--begin::Label-->
                                                        <label b-cpu6lo70wp="" for="EditorPlanTitleEn" class="d-flex align-items-center fs-5 fw-semibold mb-2">
                                                            <span b-cpu6lo70wp="" class="required">@sharedResource["TitleEn"]</span>
                                                            <span b-cpu6lo70wp="" class="ms-1" data-bs-toggle="tooltip" aria-label="@sharedResource["TitleEn"]" data-bs-original-title="@sharedResource["Enter Title En"]" data-kt-initialized="1">
                                                                <i b-cpu6lo70wp="" class="ki-duotone ki-information-5 text-gray-500 fs-6">
                                                                    <span b-cpu6lo70wp="" class="path1"></span>
                                                                    <span b-cpu6lo70wp="" class="path2"></span>
                                                                    <span b-cpu6lo70wp="" class="path3"></span>
                                                                </i>
                                                            </span>
                                                        </label>
                                                        <!--end::Label-->
                                                        <!--begin::Input-->
                                                            <input b-cpu6lo70wp=""  data-val-required="EditorPlanTitleEn" type="text" value="${spec.TitleEn}" class="form-control form-control-lg form-control-solid specForEditEN" placeholder="@sharedResource["Enter TitleEn"]">
                                                        <!--end::Input-->

                                                    </div>
                                                    <!--end::Input group-->
                                                </div>`;
                    $("#PlanSpecsEditContainer").append(specHtml);
                });
            }



                $('#showEditModal').modal('show');


            },

            failure: function (response) {
                alert(response);
            }
        });
    }

    // === VIEW ===//
    function ShowViewPopUp(WebEditorPlanId) {
    $.ajax({
        type: "GET",
        url: "/Admin/Configurations/ManageEditorPlan/Index?handler=FindWebEditorPlan",
        data: { "WebEditorPlanId": WebEditorPlanId },
        contentType: "application/json",
        dataType: "json",
        success: function (response) {
            document.getElementById("TitleENWebEditorPlanId").innerHTML = response.TitleEn;
            document.getElementById("TitleARWebEditorPlanId").innerHTML = response.TitleAr;
                document.getElementById("PriceWebEditorPlanId").innerHTML = response.Price;
            document.getElementById("PriceAfterDiscountWebEditorPlanId").innerHTML = response.PriceAfterDiscount;

            // Clear previous PlanSpecs list
            $("#PlanSpecsContainer").empty();

            // Iterate over PlanSpecs and append them to the container
            if (response.PlanSpecs && response.PlanSpecs.length > 0) {
                response.PlanSpecs.forEach(function (spec) {
                        var specHtml = `<li class="list-group-item">
                                <div class="row">
                                    <div class="col-md-6">
                                            <strong>@sharedResource["English Title"]:</strong> ${spec.TitleEn}
                                    </div>
                                    <div class="col-md-6">
                                                <strong>@sharedResource["Arabic Title"]:</strong> ${spec.TitleAr}
                                    </div>
                                </div>
                            </li>`;
                    $("#PlanSpecsContainer").append(specHtml);
                });
            }

            // Show the modal
            $('#QuickViewPoup').modal('show');
        },
        failure: function (response) {
            alert(response);
        }
    });
}


    function deleteWebEditorPlan(WebEditorPlanId) {
        $.ajax({
            type: "GET",
            url: "/Admin/Configurations/ManageEditorPlan/Index?handler=FindWebEditorPlan",
            data: { "WebEditorPlanId": WebEditorPlanId },
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
                document.getElementById("DeleteWebEditorPlanId").value = response.WebEditorPlanId
                $('#deleteRecordModal').modal('show');


            },
            failure: function (response) {
                alert(response);
            }
        });
    }
</script>